window.metamedia=window.metamedia||{},function(e,t){"use strict";var a,i,r,n=wp.media.model.Attachment;r=metamedia.media={},r.control={init:function(){t(".metamedia-control").on("click",".choose .js-trigger, .preview",function(e){var n;e.preventDefault(),a=t(this).closest(".metamedia-control"),n=a.data("target")||".target",i=0===n.indexOf("#")?t(n):a.find(n),r.control.frame().open()}).on("click",".remove .js-trigger",function(e){var i;e.preventDefault(),a=t(this).closest(".metamedia-control").removeClass("has-attachment"),a.find(".preview").html(""),i=a.data("target")||".target",0===i.indexOf("#")?t(i).val(""):a.find(i).val("")}).on("selectionChange.metamedia",function(e,a){var i,r,n=t(e.target),l=a.first(),m=l.get("sizes");m&&(r=m["post-thumbnail"]||m.medium),r=r||l.toJSON(),i=t("<img />",{src:r.url}),n.addClass("has-attachment").find(".preview").html(i)})},select:function(){var e=this.get("selection"),t=a.data("return-property")||"id";i.length&&i.val(e.first().get(t)),a.trigger("selectionChange.metamedia",[e]),e.reset([])},updateLibrarySelection:function(){var e,t,a=this.get("library").get("selection");i.length&&(t=i.val(),t&&""!==t&&-1!==t&&"0"!==t&&(e=n.get(t),e.fetch())),a.reset(e?[e]:[])},frame:function(){return this._frame?this._frame:(this._frame=wp.media({title:a.data("title")||metamediaL10n.frameTitle,library:{type:a.data("media-type")||"image"},button:{text:a.data("update-text")||metamediaL10n.frameUpdateText},multiple:a.data("select-multiple")||!1}),this._frame.on("open",this.updateLibrarySelection).state("library").on("select",this.select),this._frame)}},r.gallery={init:function(){t(".metamedia-gallery .attachments").sortable({forcePlaceholderSize:!0,forceHelperSize:!1,update:function(e,a){var i=t.map(a.item.parent().children(),function(e){return t(e).data("attachment-id")}).join(",");a.item.closest(".metamedia-gallery").find(".target").val(i)}}),t(".metamedia-gallery").on("click",".choose .js-trigger",function(e){var n;e.preventDefault(),a=t(this).closest(".metamedia-gallery"),n=a.data("target")||".target",i=0===n.indexOf("#")?t(n):a.find(n),r.gallery.frame().open()})},refresh:function(){console.log(i.val())},update:function(e){var r=[];i.length&&(i.val(e.pluck("id")),t.each(e.models,function(e,a){var i,n=a.get("sizes");console.log(a.toJSON()),n&&(i=n.thumbnail||n.medium),i=i||a.toJSON(),r.push(t("<img />",{src:i.url}).data("attachment-id",a.get("id")))}),a.find(".attachments").html(r),this.refresh())},frame:function(){var e,t,i;return e=a.find(".target").val().split(","),t=wp.media.query({post__in:e,orderby:"post__in"}),i=new wp.media.model.Selection(t.models,{props:t.props.toJSON(),multiple:!0}),i.more().done(function(){i.props.set({query:!1}),i.unmirror(),i.props.unset("orderby")}),this._frame&&this._frame.dispose(),this._frame=wp.media({frame:"post",state:a.find(".target").val()?"gallery-edit":"gallery-library",className:"media-frame metamedia-frame--gallery",editing:!0,multiple:!0,selection:i,sortable:!0}),this._frame.state("gallery-edit").on("update",this.update,this),this._frame}},r.updateSizeDropdown=function(e,a){var i,r,n=e.val();a&&t.each(a,function(e,t){e in metamediaL10n.imageSizeNames&&(i=metamediaL10n.imageSizeNames[e]),r+='<option value="'+e+'">'+i+" ("+t.width+"&times;"+t.height+")</option>"}),r||(i=metamediaL10n.imageSizeNames.full||metamediaL10n.fullSizeLabel,r='<option value="full">'+i+"</option>"),e.html(r).val(n).removeAttr("disabled")},jQuery(function(){metamedia.media.control.init(),metamedia.media.gallery.init()})}(window,jQuery);