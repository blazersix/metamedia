window.metamedia=window.metamedia||{},function(a,b){"use strict";var c,d,e,f=wp.media.model.Attachment;e=a.metamedia.media={},e.control={init:function(){b(".metamedia-control").on("click",".choose .js-trigger, .preview",function(a){a.preventDefault(),c=b(this).closest(".metamedia-control"),d=e.control.findTarget(c),e.control.frame().open()}).on("click",".remove .js-trigger",function(a){a.preventDefault(),c=b(this).closest(".metamedia-control").removeClass("has-attachment"),e.control.findTarget(c).val(""),c.find(".preview").html("")}).on("selectionChange.metamedia",function(a,c){var d,e,f=b(a.target),g=c.first(),h=g.get("sizes");h&&(e=h["post-thumbnail"]||h.medium),e=e||g.toJSON(),d=b("<img />",{src:e.url}),f.addClass("has-attachment").find(".preview").html(d)})},findTarget:function(a){var c,d=a.data("target")||".target";return c=0===d.indexOf("#")?b(d):a.find(d)},select:function(){var a=this.get("selection"),b=c.data("return-property")||"id";d.length&&d.val(a.first().get(b)).trigger("change"),c.trigger("selectionChange.metamedia",[a]),a.reset([])},updateLibrarySelection:function(){var a,b,c=this.get("library").get("selection");d.length&&(b=d.val(),b&&""!==b&&-1!==b&&"0"!==b&&(a=f.get(b),a.fetch())),c.reset(a?[a]:[])},frame:function(){return this._frame?this._frame:(this._frame=wp.media({title:c.data("title")||metamediaL10n.frameTitle,library:{type:c.data("media-type")||"image"},button:{text:c.data("update-text")||metamediaL10n.frameUpdateText},multiple:c.data("select-multiple")||!1}),this._frame.on("open",this.updateLibrarySelection).state("library").on("select",this.select),this._frame)}},e.gallery={init:function(){b(".metamedia-gallery .attachments").sortable({forcePlaceholderSize:!0,forceHelperSize:!0,start:function(a,b){b.placeholder.css("visibility","visible")},update:function(a,c){var d,f=c.item.closest(".metamedia-gallery"),g=e.control.findTarget(f);d=_.map(c.item.parent().find("[data-attachment-id]"),function(a){return b(a).data("attachment-id")}).join(","),g.val(d)}}),b(".metamedia-gallery").on("click",".choose .js-trigger",function(a){a.preventDefault(),c=b(this).closest(".metamedia-gallery"),d=e.control.findTarget(c),e.gallery.frame().open()}).on("click",".remove",function(){var a=b(this),c=a.closest(".metamedia-gallery"),d=e.control.findTarget(c);a.closest("li").remove(),d.val(e.gallery.getAttachmentIds(c).join(","))})},getAttachmentIds:function(a){return _.map(a.find("[data-attachment-id]"),function(a){return b(a).data("attachment-id")})},update:function(a){var e=[];d.length&&(d.val(a.pluck("id")).trigger("change"),_.each(a.models,function(a){var c,d=a.get("sizes");d&&(c=d.thumbnail||d.medium),c=c||a.toJSON(),e.push(b("<li />",{html:[b("<img />",{src:c.url,"data-attachment-id":a.get("id")}),'<a class="remove">&times;</a>']}))}),c.find(".attachments").html(e).sortable("refresh"))},frame:function(){var a,b,d;return a=c.find(".target").val().split(","),b=wp.media.query({post__in:a,orderby:"post__in"}),d=new wp.media.model.Selection(b.models,{props:b.props.toJSON(),multiple:!0}),d.more().done(function(){d.props.set({query:!1}),d.unmirror(),d.props.unset("orderby")}),this._frame&&this._frame.dispose(),this._frame=wp.media({frame:"post",state:c.find(".target").val()?"gallery-edit":"gallery-library",className:"media-frame metamedia-frame--gallery",editing:!0,multiple:!0,selection:d,sortable:!0}),this._frame.state("gallery-edit").on("update",this.update,this),this._frame}},e.updateSizeDropdown=function(a,b){var c,d,e=a.val();b&&_.each(b,function(a,b){b in metamediaL10n.imageSizeNames&&(c=metamediaL10n.imageSizeNames[b]),d+='<option value="'+b+'">'+c+" ("+a.width+"&times;"+a.height+")</option>"}),d||(c=metamediaL10n.imageSizeNames.full||metamediaL10n.fullSizeLabel,d='<option value="full">'+c+"</option>"),a.html(d).val(e).removeAttr("disabled")},jQuery(function(){e.control.init(),e.gallery.init()})}(this,jQuery);